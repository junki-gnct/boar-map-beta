<!DOCTYPE html>

<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/main.css">

    <!-- アイコン -->
    <script src="https://kit.fontawesome.com/767a5d66ca.js" crossorigin="anonymous"></script>

    <!-- Google Maps -->
    <script src="https://maps.google.com/maps/api/js?key=AIzaSyDc-XqIl8L2uVHPVuckvnGUkqTeZ_Re9oU&language=ja"></script>
    <script src="https://cdn.klokantech.com/maptilerlayer/v1/index.js"></script>

    <title>いのししマップぎふ</title>
</head>


<body>
    <div class="container-fluid">
        <!-- ナビゲーションバー -->
        <nav class="navbar navbar-expand-sm navbar-dark mb-3">
            <a class="navbar-brand" href="./map.html">いのししマップぎふ</a>
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navi"
                aria-controls="bs-navi" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navi">
                <ul class="navbar-nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="javascript:void(0);" onclick="logout();"><i
                                class="fas fa-sign-out-alt"></i>ログアウト</a>
                    </li>
                </ul>
            </div>
        </nav>

        <main>
            <div class="row">
                <div id="description" class="col-12">
                    <p>こんにちは、<span id="user-id"></span>様。</p>
                </div>

                <div id="map" class="col-12">
                    Map Error.
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrapのjs -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

    <script>
        // ログアウト処理
        function logout() {
            var receiptNumber = Math.floor(Math.random() * 100000);
            var data = {
                "commonHeader": {
                    "receiptNumber": receiptNumber
                },
                "userID": user_id,
                "tenantID": "210005"
            };
            var header = {
                "X-Map-Api-Access-Token": token
            };

            fetch('https://pascali.info-mapping.com/webservices/publicservice/JsonService.asmx/DeleteToken',
                {
                    method: "POST",
                    headers: header,
                    body: JSON.stringify(data)
                })
                .then(res => res.json().then(data => console.log(data)))
                .catch(error => console.log("Error:", error));
            localStorage.removeItem("access_token");
            localStorage.removeItem("login_time");
            window.location.href = "./index.html";
        }
    </script>

    <script>
        // マップ高さ処理
        $(function () {
            // ナビバーや説明の部分の高さとウィンドウの高さを取得してマップの高さを決める
            function set_map_h() {
                const nav_h = $(".navbar").outerHeight(true);
                const description_h = $("#description").outerHeight(true);
                const window_h = $(window).height();
                console.log("nav", nav_h);
                console.log("des", description_h);
                console.log("win", window_h);
                $("#map").height(window_h - nav_h - description_h);
            }
            // 最初の読み込み時に
            $(window).on('load', function () {
                set_map_h();
            });
            // ウィンドウが変化した時に
            $(window).resize(function () {
                set_map_h();
            })
        });
    </script>

    <script>
        // 地図インスタンス
        var map;

        // 現在地ボタンを作る
        function GetLocBtn(btnDiv, map) {

            // Set CSS for the btn border.
            var btnUI = document.createElement('div');
            btnUI.style.backgroundColor = '#fff';
            btnUI.style.border = '2px solid #fff';
            btnUI.style.borderRadius = '50%';
            btnUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
            btnUI.style.cursor = 'pointer';
            btnUI.style.height = '48px';
            btnUI.style.width = '48px';
            btnUI.style.padding = '0px 0px 0px 0px';
            btnUI.style.margin = '6px 6px 6px 6px';
            btnUI.style.textAlign = 'center';
            btnUI.title = 'Click to recenter the map';
            btnDiv.appendChild(btnUI);

            // Set CSS for the btn interior.
            var btnText = document.createElement('div');
            btnText.style.lineHeight = '38px';
            btnText.style.marginBottom = '3px';
            btnText.style.marginTop = '3px';
            btnText.style.padding = '0px 0px 0px 0px';
            btnText.innerHTML = '<img src="./images/my_location-24px.svg" width="24"/>';
            btnUI.appendChild(btnText);

            // Setup the click event listeners: simply set the map to Chicago.
            btnUI.addEventListener('click', function () {
                getLocation();
            });
        }

        // 現在地取得作業
        function getLocation() {
            if (navigator.geolocation) {
                window.navigator.geolocation.getCurrentPosition(
                    function (result) {
                        console.log("get loc success!");
                        //現在地の取得成功
                        var position = result.coords,
                            radius = position.accuracy,
                            latLng = new google.maps.LatLng(position.latitude, position.longitude);

                        // 現在地にカスタムピンを立てる
                        var markerOptions = {
                            map: map,
                            position: latLng,
                            icon: {
                                url: '/images/myLoc.png',
                                scaledSize: new google.maps.Size(40, 40),
                                origin: new google.maps.Point(0, 0),
                                anchor: new google.maps.Point(21, 21)
                            }
                        };
                        var marker = new google.maps.Marker(markerOptions);

                        //現在地へマップをズームして移動
                        map.setZoom(16);
                        map.setCenter(latLng);
                    },
                    function (error) {
                        //取得失敗
                        var msg;
                        switch (error.code) {
                            case 1: msg = "位置情報の利用が許可されていません"; break;
                            case 2: msg = "位置が判定できません"; break;
                            case 3: msg = "タイムアウトしました"; break;
                        }
                        alert(msg);
                    },
                    { enableHighAccuracy: true });
            } else {
                alert("本ブラウザではGeolocationが使えません");
            }
        }

        // マップ処理
        function initMap() {
            var my_location = new google.maps.LatLng(35.409528, 136.756466);
            var options = {
                zoom: 15,
                center: my_location,
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                    mapTypeIds: ['roadmap', 'terrain']
                },
                streetViewControl: false,
                fullscreenControl: false,
                mapTypeId: "roadmap",
            };
            map = new google.maps.Map(document.getElementById('map'), options);

            // 現在地ボタンを追加
            var getLocBtnDiv = document.createElement('div');
            var getLocBtn = new GetLocBtn(getLocBtnDiv, map);

            getLocBtnDiv.index = 1;
            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(getLocBtnDiv);
        }
    </script>

    <!-- 読み込み時に実施 -->
    <script>
        const token = localStorage.getItem('access_token');
        console.log("access token: ", token);
        const user_id = localStorage.getItem('user_id');
        if (!token) {
            // アクセストークンがない
            // ログイン画面へリダイレクト
            window.location.href = "./index.html";
        }

        // ページに反映
        $(function () {
            console.log("jQuery Ready!");
            $("#access-token").append(token);
            $("#user-id").append(user_id);
        });

        initMap();
    </script>
</body>

</html>