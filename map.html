<!DOCTYPE html>

<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/main.css">

    <!-- アイコン -->
    <script src="https://kit.fontawesome.com/767a5d66ca.js" crossorigin="anonymous"></script>

    <title>いのししマップぎふ</title>
</head>


<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-sm navbar-dark mb-3 sticky-top">
        <a class="navbar-brand" href="./index.html">いのししマップぎふ</a>
        <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navi" aria-controls="bs-navi"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navi">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="javascript:void(0);" onclick="logout();"><i
                            class="fas fa-sign-out-alt"></i>ログアウト</a>
                </li>
            </ul>
        </div>
    </nav>

    <main>
        <h1>マップページ</h1>
        <p>こんにちは、<span id="user-id"></span>様。</p>
        <p>あなたのアクセストークンは「<span id="access-token"></span>」です。</p>
    </main>

    <!-- Bootstrapのjs -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

    <!-- ログインできているかチェック -->
    <script>
        const token = localStorage.getItem('access_token');
        console.log("access token: ", token);
        const user_id = localStorage.getItem('user_id');
        if (!token) {
            // アクセストークンがない
            // ログイン画面へリダイレクト
            window.location.href = "./index.html";
        }

        // ページに反映
        $(function () {
            console.log("jQuery Ready!");
            $("#access-token").append(token);
            $("#user-id").append(user_id);
        });
    </script>

    <script>
        // ログアウト処理
        function logout() {
            var receiptNumber = Math.floor(Math.random() * 100000);
            var data = {
                "commonHeader": {
                    "receiptNumber": receiptNumber
                },
                "userID": user_id,
                "tenantID": "210005"
            };
            var header = {
                "X-Map-Api-Access-Token": token
            };

            fetch('https://pascali.info-mapping.com/webservices/publicservice/JsonService.asmx/DeleteToken',
                {
                    method: "POST",
                    headers: header,
                    body: JSON.stringify(data)
                })
                .then(res => res.json().then(data => console.log(data)))
                .catch(error => console.log("Error:", error));
            localStorage.removeItem("access_token");
            window.location.href = "./index.html";
        }
    </script>
</body>

</html>